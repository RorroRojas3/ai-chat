<div
  class="card border-0 rounded-5 prompt-box"
  [class.drag-over]="isDragOver"
  (dragover)="onDragOver($event)"
  (dragleave)="onDragLeave($event)"
  (drop)="onDrop($event)"
>
  <div class="card-body">
    <!-- Drag and drop overlay -->
    @if (isDragOver) {
    <div class="drag-overlay">
      <div class="drag-content">
        <i class="bi bi-files drag-icon"></i>
        <p class="drag-text">Drop file(s)</p>
      </div>
    </div>
    }
    <form
      id="promptForm"
      (ngSubmit)="onClickCreateSession()"
      (keydown)="onKeyDown($event)"
    >
      <div class="position-relative">
        <div class="row">
          <div class="col-12">
            <textarea
              class="form-control border-0 prompt-box-textarea"
              id="promptInput"
              rows="4"
              placeholder="Ask anything..."
              [(ngModel)]="prompt"
              [ngModelOptions]="{ standalone: true }"
              (keydown)="onTextareaKeyDown($event)"
            ></textarea>
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <div
              class="d-flex align-items-center justify-content-between gap-2 flex-wrap"
            >
              <!-- Left side: Model and File buttons -->
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <!-- Model Dropdown -->
                <div class="dropdown">
                  <button
                    class="btn btn-prompt-box dropdown-toggle"
                    type="button"
                    id="dropdownMenuButton"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    @if (this.storeService.selectedModel().name) {
                    <i
                      class="me-2 {{
                        getServiceIcon(
                          this.storeService.selectedModel().aiServiceId
                        )
                      }}"
                    ></i>
                    <span class="d-none d-sm-inline">{{
                      this.storeService.selectedModel().name
                    }}</span>
                    } @else {
                    <i class="bi bi-robot me-2"></i>
                    <span class="d-none d-sm-inline">Models...</span>
                    }
                  </button>
                  <ul
                    class="dropdown-menu"
                    style="background-color: var(--color-light-blue)"
                    aria-labelledby="dropdownMenuButton"
                  >
                    @for (model of this.storeService.models(); track model) {
                    <li>
                      <a class="dropdown-item" (click)="onModelChange(model)">
                        <i
                          class="me-2 {{ getServiceIcon(model.aiServiceId) }}"
                        ></i>
                        {{ model.name }}
                      </a>
                    </li>
                    }
                  </ul>
                </div>

                <!-- MCP Dropdown (Multi-select) -->
                <div class="dropdown">
                  <button
                    class="btn btn-prompt-box dropdown-toggle"
                    type="button"
                    id="mcpDropdownButton"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    title="Select Tools"
                  >
                    <i class="bi bi-wrench me-2"></i>
                    <span class="d-none d-sm-inline">{{
                      getMcpButtonText()
                    }}</span>
                  </button>
                  <ul
                    class="dropdown-menu"
                    style="background-color: var(--color-light-blue)"
                    aria-labelledby="mcpDropdownButton"
                  >
                    @if (this.storeService.mcps().length === 0) {
                    <li>
                      <span class="dropdown-item-text text-muted"
                        >No Tools available</span
                      >
                    </li>
                    } @else { @for (mcp of this.storeService.mcps(); track
                    mcp.name) {
                    <li>
                      <a
                        class="dropdown-item d-flex align-items-center"
                        (click)="toggleMcpSelection(mcp, $event)"
                        style="cursor: pointer"
                      >
                        <i class="bi bi-wrench me-2"></i>
                        <span
                          class="flex-grow-1 text-truncate"
                          [title]="mcp.name"
                          >{{ mcp.name }}</span
                        >
                        @if (isMcpSelected(mcp)) {
                        <i
                          class="bi bi-check-circle-fill ms-2 text-success"
                        ></i>
                        }
                      </a>
                    </li>
                    } }
                  </ul>
                </div>

                <!-- File Attachment Button -->
                @if (isFileAttachmentAllowed()) {
                <button
                  type="button"
                  class="btn btn-prompt-box"
                  (click)="fileInput.click()"
                  title="Attach files"
                >
                  <i class="bi bi-paperclip"></i>
                </button>
                }

                <!-- Download Conversation History Dropdown -->
                @if (this.storeService.sessionId() &&
                this.storeService.messages().length > 2 &&
                !this.storeService.isStreaming()) {
                <div class="dropdown">
                  <button
                    class="btn btn-prompt-box dropdown-toggle"
                    type="button"
                    id="downloadDropdown"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    title="Download conversation history"
                  >
                    <i class="bi bi-download"></i>
                  </button>
                  <ul
                    class="dropdown-menu"
                    style="background-color: var(--color-light-blue)"
                    aria-labelledby="downloadDropdown"
                  >
                    @for (format of documentFormats; track format) {
                    <li>
                      <a
                        class="dropdown-item"
                        (click)="onDownloadConversationHistory(format)"
                      >
                        <i class="me-2 {{ getFormatIcon(format) }}"></i>
                        {{ getFormatName(format) }}
                      </a>
                    </li>
                    }
                  </ul>
                </div>
                }
              </div>

              <!-- Right side: Send button -->
              <div class="ms-auto">
                <button
                  type="submit"
                  class="btn btn-prompt-box"
                  [disabled]="this.storeService.disablePromptButton()"
                  (click)="onClickCreateSession()"
                  title="Send message"
                >
                  <i class="bi bi-send"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        <input
          type="file"
          #fileInput
          multiple
          style="display: none"
          (change)="onFileSelect($event)"
          [accept]="getAcceptedFileTypes()"
        />
      </div>
    </form>

    <!-- File cards display -->
    @if (attachedFiles.length > 0 && showAttachedFiles) {
    <div class="file-cards-container mt-1">
      <div class="file-cards-scroll">
        @for (file of attachedFiles; track file.id) {
        <div class="file-card card">
          <div class="file-card-body card-body text-center">
            <div class="file-card-remove">
              <span class="badge bg-danger" (click)="removeFile(file.id)">
                <i class="bi bi-x"></i>
              </span>
            </div>
            <div class="file-card-icon">
              <i class="bi bi-file-earmark-pdf"></i>
            </div>
            <div class="file-card-name">{{ file.name }}</div>
            <div class="file-card-size">{{ formatFileSize(file.size) }}</div>
          </div>
        </div>
        }
      </div>
    </div>
    }
  </div>
</div>
