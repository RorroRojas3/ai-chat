<div
  class="card border-0 rounded-5 prompt-box"
  [class.drag-over]="isDragOver"
  (dragover)="onDragOver($event)"
  (dragleave)="onDragLeave($event)"
  (drop)="onDrop($event)"
  role="region"
  aria-label="Message input area"
>
  <div class="card-body">
    <!-- Drag and drop overlay -->
    @if (isDragOver) {
    <div class="drag-overlay" aria-live="polite">
      <div class="drag-content">
        <i class="bi bi-files drag-icon" aria-hidden="true"></i>
        <p class="drag-text">Drop file(s)</p>
      </div>
    </div>
    }
    <form
      id="promptForm"
      (ngSubmit)="onClickCreateSession()"
      (keydown)="onKeyDown($event)"
    >
      <div class="position-relative">
        <div class="row">
          <div class="col-12">
            <label for="promptInput" class="visually-hidden"
              >Enter your message</label
            >
            <textarea
              class="form-control border-0 prompt-box-textarea"
              id="promptInput"
              rows="4"
              placeholder="Ask anything..."
              [(ngModel)]="prompt"
              [ngModelOptions]="{ standalone: true }"
              (keydown)="onTextareaKeyDown($event)"
              aria-describedby="promptHelp"
            ></textarea>
            <span id="promptHelp" class="visually-hidden"
              >Press Enter to send, Shift+Enter for new line</span
            >
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <div
              class="d-flex align-items-center justify-content-between gap-2 flex-wrap"
            >
              <!-- Left side: Model and File buttons -->
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <!-- Model Dropdown -->
                <div class="dropdown">
                  <button
                    class="btn btn-primary dropdown-toggle"
                    type="button"
                    id="dropdownMenuButton"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    [attr.aria-label]="
                      storeService.selectedModel().name
                        ? 'Selected model: ' + storeService.selectedModel().name
                        : 'Select a model'
                    "
                  >
                    @if (storeService.selectedModel().name) {
                    <i
                      class="me-2 {{
                        getServiceIcon(storeService.selectedModel().aiServiceId)
                      }}"
                      aria-hidden="true"
                    ></i>
                    <span class="d-none d-sm-inline">{{
                      storeService.selectedModel().name
                    }}</span>
                    } @else {
                    <i class="bi bi-robot me-2" aria-hidden="true"></i>
                    <span class="d-none d-sm-inline">Models...</span>
                    }
                  </button>
                  <ul
                    class="dropdown-menu"
                    aria-labelledby="dropdownMenuButton"
                  >
                    @for (model of storeService.models(); track model.id) {
                    <li>
                      <button
                        type="button"
                        class="dropdown-item d-flex align-items-center"
                        (click)="onModelChange(model)"
                      >
                        <i
                          class="me-2 {{ getServiceIcon(model.aiServiceId) }}"
                          aria-hidden="true"
                        ></i>
                        <span class="flex-grow-1">{{ model.name }}</span>
                        @if (storeService.selectedModel().id === model.id) {
                        <i
                          class="bi bi-check-circle-fill ms-2 text-success"
                          aria-hidden="true"
                        ></i>
                        }
                      </button>
                    </li>
                    }
                  </ul>
                </div>

                <!-- MCP Dropdown (Multi-select) -->
                <div class="dropdown">
                  <button
                    class="btn btn-primary dropdown-toggle"
                    type="button"
                    id="mcpDropdownButton"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    [attr.title]="'Select Tools - ' + getMcpButtonText()"
                    [attr.aria-label]="'Tools: ' + getMcpButtonText()"
                  >
                    <i class="bi bi-wrench me-2" aria-hidden="true"></i>
                    <span class="d-none d-sm-inline">{{
                      getMcpButtonText()
                    }}</span>
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="mcpDropdownButton">
                    @if (storeService.mcps().length === 0) {
                    <li>
                      <span class="dropdown-item-text text-muted"
                        >No Tools available</span
                      >
                    </li>
                    } @else { @for (mcp of storeService.mcps(); track mcp.name)
                    {
                    <li>
                      <button
                        type="button"
                        class="dropdown-item d-flex align-items-center"
                        (click)="toggleMcpSelection(mcp, $event)"
                        [attr.aria-label]="
                          isMcpSelected(mcp)
                            ? 'Deselect tool: ' + mcp.name
                            : 'Select tool: ' + mcp.name
                        "
                      >
                        <i class="bi bi-wrench me-2" aria-hidden="true"></i>
                        <span
                          class="flex-grow-1 text-truncate"
                          [title]="mcp.name"
                          >{{ mcp.name }}</span
                        >
                        @if (isMcpSelected(mcp)) {
                        <i
                          class="bi bi-check-circle-fill ms-2 text-success"
                          aria-hidden="true"
                        ></i>
                        }
                      </button>
                    </li>
                    } }
                  </ul>
                </div>

                <!-- File Attachment Button -->
                @if (isFileAttachmentAllowed()) {
                <button
                  type="button"
                  class="btn btn-primary"
                  (click)="fileInput.click()"
                  [attr.title]="
                    'Attach files - Allowed types: ' + getAcceptedFileTypes()
                  "
                  aria-label="Attach files"
                >
                  <i class="bi bi-paperclip" aria-hidden="true"></i>
                </button>
                }

                <!-- Download Conversation History Dropdown -->
                @if (storeService.session() && storeService.messages().length >
                2 && !storeService.isStreaming()) {
                <div class="dropdown">
                  <button
                    class="btn btn-primary dropdown-toggle"
                    type="button"
                    id="downloadDropdown"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    title="Download conversation history"
                    aria-label="Download conversation history"
                  >
                    <i class="bi bi-download" aria-hidden="true"></i>
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="downloadDropdown">
                    @for (format of getDocumentFormats(); track format) {
                    <li>
                      <button
                        type="button"
                        class="dropdown-item"
                        (click)="onDownloadConversationHistory(format)"
                      >
                        <i
                          class="me-2 {{ getFormatIcon(format) }}"
                          aria-hidden="true"
                        ></i>
                        {{ getFormatName(format) }}
                      </button>
                    </li>
                    }
                  </ul>
                </div>
                }
              </div>

              <!-- Right side: Send button -->
              <div class="ms-auto">
                @if (!storeService.isStreaming()) {
                <button
                  type="submit"
                  class="btn btn-lg btn-primary"
                  (click)="onClickCreateSession()"
                  title="Send message"
                  [attr.aria-label]="'Send message'"
                >
                  <i class="bi bi-send" aria-hidden="true"></i></button
                >} @else {
                <button
                  type="button"
                  class="btn btn-lg btn-primary"
                  (click)="onClickStopSession()"
                  title="Stop message"
                  [attr.aria-label]="'Stop message'"
                >
                  <i class="bi bi-stop-circle" aria-hidden="true"></i>
                </button>
                }
              </div>
            </div>
          </div>
        </div>
        <input
          type="file"
          #fileInput
          multiple
          style="display: none"
          (change)="onFileSelect($event)"
          [accept]="getAcceptedFileTypes()"
          aria-label="File input for attachments"
        />
      </div>
    </form>

    <!-- File cards display -->
    @if (attachedFiles.length > 0 && showAttachedFiles) {
    <div
      class="file-cards-container mt-1"
      role="list"
      aria-label="Attached files"
    >
      <div class="file-cards-scroll">
        @for (file of attachedFiles; track file.id) {
        <div class="file-card card" role="listitem">
          <div class="file-card-body card-body text-center">
            <div class="file-card-remove">
              <button
                type="button"
                class="badge bg-danger border-0"
                (click)="removeFile(file.id)"
                [attr.aria-label]="'Remove file: ' + file.name"
              >
                <i class="bi bi-x" aria-hidden="true"></i>
              </button>
            </div>
            <div class="file-card-icon">
              <i class="bi bi-file-earmark-pdf" aria-hidden="true"></i>
            </div>
            <div class="file-card-name">{{ file.name }}</div>
            <div class="file-card-size">{{ formatFileSize(file.size) }}</div>
          </div>
        </div>
        }
      </div>
    </div>
    }
  </div>
</div>
